<%- include('partials/header'); -%>

    <main class="mb-8">
        <div id="" class="flex-1 p-10 text-lg font-bold mt-10">
            <h1 class="text-2xl text-center font-bold mb-6">Account Settings</h1>
            <div class="bg-[#111111] shadow-lg rounded-lg p-6 border border-gray-700 mb-6">
                <h2 class="text-xl font-bold mb-4">Account Details</h2>
                <div id="account-details" class="text-gray-300">
                    <% if (user) { %>
                        <div class="flex items-center justify-between">
                            <p>Username: <%= user.username %>
                            </p>
                            <p>Email: <%= user.email %>
                            </p>
                        </div>
                        <% } else { %>
                            <p class="text-red-500">User details not available.</p>
                            <% } %>
                </div>
            </div>
            <div class="bg-[#111111] shadow-lg rounded-lg p-6 border border-gray-700">
                <h2 class="text-xl font-bold mb-4">Reset Password</h2>
                <div id="password-reset-section">
                    <form id="otp-request-form">
                        <label for="email" class="text-gray-300 mb-2">Email:</label>
                        <input type="email" id="email" name="email"
                            class="bg-[#111111] text-white border border-gray-600 p-2 rounded w-full mb-4" required>
                        <button type="submit"
                            class="bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 focus:outline-none">Request
                            OTP</button>
                    </form>
                    <form id="password-reset-form" class="hidden">
                        <label for="otp" class="text-gray-300 mb-2">OTP:</label>
                        <input type="text" id="otp" name="otp"
                            class="bg-[#111111] text-white border border-gray-600 p-2 rounded w-full mb-4" required>
                        <label for="new-password" class="text-gray-300 mb-2">New Password:</label>
                        <input type="password" id="new-password" name="new-password"
                            class="bg-gray-800 text-white border border-gray-600 p-2 rounded w-full mb-4" required>
                        <button type="submit"
                            class="bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 focus:outline-none">Reset
                            Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-10">
            <div class="bg-[#111111] p-6 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-xl font-bold mb-4 text-white">Alert</h2>
                <p id="alertMessage" class="text-gray-300 mb-4"></p>
                <div class="flex justify-end">
                    <button type="button" class="bg-gray-500 text-white py-2 px-4 rounded"
                        id="closeAlertButton">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Get modal elements
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const closeAlertButton = document.getElementById('closeAlertButton');

        // Function to show alert modal
        function showAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        // Function to hide alert modal
        closeAlertButton.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        document.addEventListener('DOMContentLoaded', function () {
            const otpRequestForm = document.getElementById('otp-request-form');
            const passwordResetForm = document.getElementById('password-reset-form');

            otpRequestForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = event.target.email.value;
                try {
                    const response = await fetch('/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });
                    const data = await response.json();
                    if (response.ok && data.message === 'Password reset OTP sent to your email') {
                        otpRequestForm.classList.add('hidden');
                        passwordResetForm.classList.remove('hidden');
                    } else {
                        showAlert(data.message || 'Failed to send OTP');
                    }
                } catch (error) {
                    showAlert('Error requesting OTP');
                }
            });

            passwordResetForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = otpRequestForm.email.value;
                const otp = event.target.otp.value;
                const newPassword = event.target['new-password'].value;
                try {
                    const response = await fetch('/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, otp, newPassword })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showAlert('Password reset successfully');
                        otpRequestForm.reset();
                        passwordResetForm.reset();
                        otpRequestForm.classList.remove('hidden');
                        passwordResetForm.classList.add('hidden');
                    } else {
                        showAlert(data.message || 'Failed to reset password');
                    }
                } catch (error) {
                    showAlert('Error resetting password');
                }
            });
        });
    </script>

    <%- include('partials/footer'); -%>